<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­ä¹¦è½¬æ¢ä¸ç¿»è¯‘ - MiniTools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 8px 16px;
            background: #e0e0e0;
            color: #333;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #d0d0d0;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .deps-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .deps-status h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .dep-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #e0e0e0;
        }
        
        .dep-item.installed {
            border-left-color: #28a745;
        }
        
        .dep-item.not-installed {
            border-left-color: #dc3545;
        }
        
        .dep-name {
            font-weight: 600;
            color: #333;
        }
        
        .dep-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .dep-status-badge.installed {
            background: #d4edda;
            color: #155724;
        }
        
        .dep-status-badge.not-installed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
            border-color: #5568d3;
        }
        
        .upload-area.drag-over {
            background: #e7eaff;
            border-color: #4450b5;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .file-info h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input[type="text"],
        select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        input:disabled, select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f5f5f5;
        }
        
        .progress {
            background: #e0e0e0;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }
        
        .progress.show {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .result.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .result h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .result.success h3 {
            color: #155724;
        }
        
        .result.error h3 {
            color: #721c24;
        }
        
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .download-link:hover {
            background: #5568d3;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .warning-box p {
            color: #856404;
            font-size: 14px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
        
        <h1>ğŸ“š ç”µå­ä¹¦è½¬æ¢ä¸ç¿»è¯‘</h1>
        <p class="subtitle">æ”¯æŒæ ¼å¼è½¬æ¢ã€OCRè¯†åˆ«ã€AIç¿»è¯‘</p>
        
        <!-- ä¾èµ–çŠ¶æ€ -->
        <div class="deps-status" id="deps-status">
            <h3>ğŸ”§ ä¾èµ–å·¥å…·çŠ¶æ€</h3>
            <div id="deps-list">
                <div style="text-align: center; color: #999;">æ­£åœ¨æ£€æµ‹...</div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" data-tab="convert">æ ¼å¼è½¬æ¢</button>
            <button class="tab" data-tab="ocr">OCRè¯†åˆ«</button>
            <button class="tab" data-tab="translate">AIç¿»è¯‘</button>
        </div>
        
        <!-- æ ¼å¼è½¬æ¢æ ‡ç­¾ -->
        <div id="convert-tab" class="tab-content active">
            <div class="upload-area" id="upload-area-convert">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ç”µå­ä¹¦æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ PDF, EPUB, MOBI, TXT, AZW3, DOCX ç­‰æ ¼å¼</div>
                <input type="file" id="file-input-convert" class="file-input" accept=".pdf,.epub,.mobi,.txt,.azw3,.docx">
            </div>
            
            <div class="file-info" id="file-info-convert">
                <h3>ğŸ“Š æ–‡ä»¶ä¿¡æ¯</h3>
                <div class="info-grid" id="info-grid-convert"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label for="output-format-convert">è¾“å‡ºæ ¼å¼</label>
                    <select id="output-format-convert">
                        <option value="epub">EPUB</option>
                        <option value="pdf">PDF</option>
                        <option value="mobi">MOBI</option>
                        <option value="txt">TXT</option>
                        <option value="azw3">AZW3</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="output-filename-convert">è¾“å‡ºæ–‡ä»¶å</label>
                    <input type="text" id="output-filename-convert" placeholder="converted_book.epub">
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="btn-convert" disabled>ğŸ”„ å¼€å§‹è½¬æ¢</button>
            </div>
            
            <div class="progress" id="progress-convert">
                <div class="progress-fill" id="progress-fill-convert">0%</div>
            </div>
            <div class="progress-text" id="progress-text-convert"></div>
            
            <div class="result" id="result-convert"></div>
        </div>
        
        <!-- OCRè¯†åˆ«æ ‡ç­¾ -->
        <div id="ocr-tab" class="tab-content">
            <div class="warning-box">
                <h4>âš ï¸ OCRåŠŸèƒ½è¯´æ˜</h4>
                <p>â€¢ æ­¤åŠŸèƒ½ç”¨äºè¯†åˆ«æ‰«æç‰ˆPDFä¸­çš„æ–‡å­—</p>
                <p>â€¢ éœ€è¦å®‰è£…Tesseract OCRå’ŒOCRmyPDFå·¥å…·</p>
                <p>â€¢ å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
            </div>
            
            <div class="upload-area" id="upload-area-ocr">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">ä»…æ”¯æŒ PDF æ ¼å¼</div>
                <input type="file" id="file-input-ocr" class="file-input" accept=".pdf">
            </div>
            
            <div class="file-info" id="file-info-ocr">
                <h3>ğŸ“Š æ–‡ä»¶ä¿¡æ¯</h3>
                <div class="info-grid" id="info-grid-ocr"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label for="output-format-ocr">è¾“å‡ºæ ¼å¼</label>
                    <select id="output-format-ocr">
                        <option value="pdf">PDF</option>
                        <option value="epub">EPUB</option>
                        <option value="txt">TXT</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="output-filename-ocr">è¾“å‡ºæ–‡ä»¶å</label>
                    <input type="text" id="output-filename-ocr" placeholder="ocr_book.pdf">
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="btn-ocr" disabled>ğŸ” å¼€å§‹OCRè¯†åˆ«</button>
            </div>
            
            <div class="progress" id="progress-ocr">
                <div class="progress-fill" id="progress-fill-ocr">0%</div>
            </div>
            <div class="progress-text" id="progress-text-ocr"></div>
            
            <div class="result" id="result-ocr"></div>
        </div>
        
        <!-- AIç¿»è¯‘æ ‡ç­¾ -->
        <div id="translate-tab" class="tab-content">
            <div class="warning-box">
                <h4>âš ï¸ ç¿»è¯‘åŠŸèƒ½è¯´æ˜</h4>
                <p>â€¢ æ”¯æŒä½¿ç”¨Ollamaæˆ–DeepSeekè¿›è¡Œç¿»è¯‘</p>
                <p>â€¢ ç¿»è¯‘è¾ƒé•¿å†…å®¹éœ€è¦è¾ƒå¤šæ—¶é—´</p>
                <p>â€¢ å»ºè®®å…ˆæµ‹è¯•è¾ƒçŸ­çš„æ–‡æ¡£</p>
                <p>â€¢ DeepSeekéœ€è¦è®¾ç½®DEEPSEEK_API_KEYç¯å¢ƒå˜é‡</p>
            </div>
            
            <div class="upload-area" id="upload-area-translate">
                <div class="upload-icon">ğŸŒ</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ç”µå­ä¹¦æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ PDF, EPUB, TXT ç­‰æ ¼å¼</div>
                <input type="file" id="file-input-translate" class="file-input" accept=".pdf,.epub,.txt,.mobi">
            </div>
            
            <div class="file-info" id="file-info-translate">
                <h3>ğŸ“Š æ–‡ä»¶ä¿¡æ¯</h3>
                <div class="info-grid" id="info-grid-translate"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label for="translate-provider">ç¿»è¯‘æœåŠ¡</label>
                    <select id="translate-provider">
                        <option value="ollama">Ollama</option>
                        <option value="deepseek">DeepSeek</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="translate-model">æ¨¡å‹</label>
                    <select id="translate-model">
                        <option value="qwen2.5:7b">Qwen2.5 7B</option>
                        <option value="qwen2.5:14b">Qwen2.5 14B</option>
                        <option value="deepseek-chat">DeepSeek Chat</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="target-language">ç›®æ ‡è¯­è¨€</label>
                    <select id="target-language">
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="output-format-translate">è¾“å‡ºæ ¼å¼</label>
                    <select id="output-format-translate">
                        <option value="epub">EPUB</option>
                        <option value="pdf">PDF</option>
                        <option value="txt">TXT</option>
                    </select>
                </div>
                
                <div class="control-group full-width">
                    <div class="checkbox-group">
                        <input type="checkbox" id="bilingual" checked>
                        <label for="bilingual" style="margin: 0;">ç”ŸæˆåŒè¯­å¯¹ç…§ç‰ˆæœ¬</label>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="btn-translate" disabled>ğŸŒ å¼€å§‹ç¿»è¯‘</button>
            </div>
            
            <div class="progress" id="progress-translate">
                <div class="progress-fill" id="progress-fill-translate">0%</div>
            </div>
            <div class="progress-text" id="progress-text-translate"></div>
            
            <div class="result" id="result-translate"></div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}`;
        let uploadedFiles = {
            convert: null,
            ocr: null,
            translate: null
        };
        
        // å…¨å±€å˜é‡ï¼šå­˜å‚¨å¯ç”¨çš„Ollamaæ¨¡å‹
        let availableOllamaModels = [];
        
        // å¤„ç†çŠ¶æ€æ ‡å¿—
        let isConverting = false;
        let isOCRProcessing = false;
        let isTranslating = false;
        
        // é˜²æ­¢ç”¨æˆ·ç¦»å¼€é¡µé¢
        window.addEventListener('beforeunload', (e) => {
            if (isConverting || isOCRProcessing || isTranslating) {
                e.preventDefault();
                e.returnValue = 'æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return 'æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
        });
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // åˆ‡æ¢æ ‡ç­¾æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
        
        // æ£€æŸ¥ä¾èµ–å·¥å…·
        async function checkDependencies() {
            try {
                const response = await fetch(`${API_BASE_URL}/plugins/EbookConverter/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'check_dependencies'
                    })
                });
                
                const result = await response.json();
                displayDependencies(result.dependencies);
                
                // ä¿å­˜Ollamaæ¨¡å‹åˆ—è¡¨
                if (result.dependencies && result.dependencies.ollama && result.dependencies.ollama.models) {
                    availableOllamaModels = result.dependencies.ollama.models;
                }
            } catch (error) {
                document.getElementById('deps-list').innerHTML = 
                    '<div style="color: #dc3545;">æ£€æµ‹å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // æ˜¾ç¤ºä¾èµ–çŠ¶æ€
        function displayDependencies(deps) {
            const depsList = document.getElementById('deps-list');
            let html = '';
            
            const depNames = {
                'calibre': 'Calibre (ebook-convert)',
                'tesseract': 'Tesseract OCR',
                'ollama': 'Ollama'
            };
            
            for (const [key, info] of Object.entries(deps)) {
                const isInstalled = info.installed || info.available;
                const statusClass = isInstalled ? 'installed' : 'not-installed';
                const statusText = isInstalled ? 'å·²å®‰è£…' : 'æœªå®‰è£…';
                
                html += `
                    <div class="dep-item ${statusClass}">
                        <div>
                            <span class="dep-name">${depNames[key] || key}</span>
                            ${info.version ? `<div style="font-size: 12px; color: #666;">${info.version}</div>` : ''}
                            ${key === 'ollama' && info.models && info.models.length > 0 ? `<div style="font-size: 12px; color: #666;">å¯ç”¨æ¨¡å‹æ•°: ${info.models.length}ä¸ª</div>` : ''}
                        </div>
                        <span class="dep-status-badge ${statusClass}">${statusText}</span>
                    </div>
                `;
            }
            
            depsList.innerHTML = html;
        }
        
        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function setupFileUpload(tabName) {
            const uploadArea = document.getElementById(`upload-area-${tabName}`);
            const fileInput = document.getElementById(`file-input-${tabName}`);
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(tabName, files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(tabName, e.target.files[0]);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(tabName, file) {
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            const progressDiv = document.getElementById(`progress-${tabName}`);
            const progressFill = document.getElementById(`progress-fill-${tabName}`);
            const progressText = document.getElementById(`progress-text-${tabName}`);
            
            progressDiv.classList.add('show');
            progressText.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            
            try {
                // ä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 413) {
                    throw new Error('æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§æ”¯æŒ2GB');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    uploadedFiles[tabName] = result.filepath;
                    progressFill.style.width = '100%';
                    progressFill.textContent = '100%';
                    progressText.textContent = 'ä¸Šä¼ å®Œæˆ';
                    
                    // è‡ªåŠ¨è®¾ç½®è¾“å‡ºæ–‡ä»¶åï¼ˆä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼‰
                    const fileName = file.name;
                    const fileNameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                    const outputFilenameInput = document.getElementById(`output-filename-${tabName}`);
                    if (outputFilenameInput && !outputFilenameInput.value) {
                        const outputFormat = document.getElementById(`output-format-${tabName}`).value;
                        outputFilenameInput.value = `${fileNameWithoutExt}.${outputFormat}`;
                    }
                    
                    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                    await displayFileInfo(tabName, result.filepath);
                    
                    // å¯ç”¨æ“ä½œæŒ‰é’®
                    document.getElementById(`btn-${tabName}`).disabled = false;
                    
                    setTimeout(() => {
                        progressDiv.classList.remove('show');
                    }, 1000);
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                progressText.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                progressFill.style.background = '#dc3545';
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        async function displayFileInfo(tabName, filepath) {
            try {
                const response = await fetch(`${API_BASE_URL}/plugins/EbookConverter/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'info',
                        input_file: filepath
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.info) {
                    const info = result.info;
                    const fileInfo = document.getElementById(`file-info-${tabName}`);
                    const infoGrid = document.getElementById(`info-grid-${tabName}`);
                    
                    let html = `
                        <div class="info-item">
                            <div class="info-label">æ–‡ä»¶å</div>
                            <div class="info-value">${info.filename}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æ ¼å¼</div>
                            <div class="info-value">${info.format.toUpperCase()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å¤§å°</div>
                            <div class="info-value">${info.size}</div>
                        </div>
                    `;
                    
                    if (info.title) {
                        html += `
                            <div class="info-item">
                                <div class="info-label">æ ‡é¢˜</div>
                                <div class="info-value">${info.title}</div>
                            </div>
                        `;
                    }
                    
                    if (info.author) {
                        html += `
                            <div class="info-item">
                                <div class="info-label">ä½œè€…</div>
                                <div class="info-value">${info.author}</div>
                            </div>
                        `;
                    }
                    
                    if (info.pages) {
                        html += `
                            <div class="info-item">
                                <div class="info-label">é¡µæ•°</div>
                                <div class="info-value">${info.pages}</div>
                            </div>
                        `;
                    }
                    
                    if (info.language) {
                        html += `
                            <div class="info-item">
                                <div class="info-label">è¯­è¨€</div>
                                <div class="info-value">${info.language}</div>
                            </div>
                        `;
                    }
                    
                    infoGrid.innerHTML = html;
                    fileInfo.classList.add('show');
                }
            } catch (error) {
                console.error('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // ç¦ç”¨/å¯ç”¨æ ¼å¼è½¬æ¢æ§ä»¶
        function disableConvertControls() {
            document.getElementById('btn-convert').disabled = true;
            document.getElementById('file-input-convert').disabled = true;
            document.getElementById('output-format-convert').disabled = true;
            document.getElementById('output-filename-convert').disabled = true;
            
            // åŒæ—¶ç¦ç”¨å…¶ä»–æ ‡ç­¾é¡µçš„æ§ä»¶
            disableOCRControls();
            disableTranslateControlsOnly();
        }
        
        function enableConvertControls() {
            document.getElementById('btn-convert').disabled = false;
            document.getElementById('file-input-convert').disabled = false;
            document.getElementById('output-format-convert').disabled = false;
            document.getElementById('output-filename-convert').disabled = false;
            
            // åŒæ—¶å¯ç”¨å…¶ä»–æ ‡ç­¾é¡µçš„æ§ä»¶
            enableOCRControls();
            enableTranslateControlsOnly();
        }
        
        // ç¦ç”¨/å¯ç”¨OCRæ§ä»¶
        function disableOCRControls() {
            document.getElementById('btn-ocr').disabled = true;
            document.getElementById('file-input-ocr').disabled = true;
            document.getElementById('output-format-ocr').disabled = true;
            document.getElementById('output-filename-ocr').disabled = true;
            
            // åŒæ—¶ç¦ç”¨å…¶ä»–æ ‡ç­¾é¡µçš„æ§ä»¶
            disableConvertControlsOnly();
            disableTranslateControlsOnly();
        }
        
        function enableOCRControls() {
            document.getElementById('btn-ocr').disabled = false;
            document.getElementById('file-input-ocr').disabled = false;
            document.getElementById('output-format-ocr').disabled = false;
            document.getElementById('output-filename-ocr').disabled = false;
            
            // åŒæ—¶å¯ç”¨å…¶ä»–æ ‡ç­¾é¡µçš„æ§ä»¶
            enableConvertControlsOnly();
            enableTranslateControlsOnly();
        }
        
        // åªç¦ç”¨/å¯ç”¨æœ¬æ ‡ç­¾é¡µï¼ˆé¿å…å¾ªç¯è°ƒç”¨ï¼‰
        function disableConvertControlsOnly() {
            document.getElementById('btn-convert').disabled = true;
            document.getElementById('file-input-convert').disabled = true;
            document.getElementById('output-format-convert').disabled = true;
            document.getElementById('output-filename-convert').disabled = true;
        }
        
        function enableConvertControlsOnly() {
            document.getElementById('btn-convert').disabled = false;
            document.getElementById('file-input-convert').disabled = false;
            document.getElementById('output-format-convert').disabled = false;
            document.getElementById('output-filename-convert').disabled = false;
        }
        
        function disableOCRControlsOnly() {
            document.getElementById('btn-ocr').disabled = true;
            document.getElementById('file-input-ocr').disabled = true;
            document.getElementById('output-format-ocr').disabled = true;
            document.getElementById('output-filename-ocr').disabled = true;
        }
        
        function enableOCRControlsOnly() {
            document.getElementById('btn-ocr').disabled = false;
            document.getElementById('file-input-ocr').disabled = false;
            document.getElementById('output-format-ocr').disabled = false;
            document.getElementById('output-filename-ocr').disabled = false;
        }
        
        function disableTranslateControlsOnly() {
            document.getElementById('btn-translate').disabled = true;
            document.getElementById('file-input-translate').disabled = true;
            document.getElementById('translate-provider').disabled = true;
            document.getElementById('translate-model').disabled = true;
            document.getElementById('target-language').disabled = true;
            document.getElementById('output-format-translate').disabled = true;
            document.getElementById('bilingual').disabled = true;
        }
        
        function enableTranslateControlsOnly() {
            document.getElementById('btn-translate').disabled = false;
            document.getElementById('file-input-translate').disabled = false;
            document.getElementById('translate-provider').disabled = false;
            document.getElementById('translate-model').disabled = false;
            document.getElementById('target-language').disabled = false;
            document.getElementById('output-format-translate').disabled = false;
            document.getElementById('bilingual').disabled = false;
        }
        
        // ç¦ç”¨/å¯ç”¨ç¿»è¯‘æ§ä»¶
        function disableTranslateControls() {
            document.getElementById('btn-translate').disabled = true;
            document.getElementById('file-input-translate').disabled = true;
            document.getElementById('translate-provider').disabled = true;
            document.getElementById('translate-model').disabled = true;
            document.getElementById('target-language').disabled = true;
            document.getElementById('output-format-translate').disabled = true;
            document.getElementById('bilingual').disabled = true;
            
            // åŒæ—¶ç¦ç”¨å…¶ä»–æ ‡ç­¾é¡µçš„æ§ä»¶
            disableConvertControlsOnly();
            disableOCRControlsOnly();
        }
        
        function enableTranslateControls() {
            document.getElementById('btn-translate').disabled = false;
            document.getElementById('file-input-translate').disabled = false;
            document.getElementById('translate-provider').disabled = false;
            document.getElementById('translate-model').disabled = false;
            document.getElementById('target-language').disabled = false;
            document.getElementById('output-format-translate').disabled = false;
            document.getElementById('bilingual').disabled = false;
            
            // åŒæ—¶å¯ç”¨å…¶ä»–æ ‡ç­¾é¡µçš„æ§ä»¶
            enableConvertControlsOnly();
            enableOCRControlsOnly();
        }
        
        // æ ¼å¼è½¬æ¢
        async function convertFormat() {
            const outputFormat = document.getElementById('output-format-convert').value;
            const outputFilename = document.getElementById('output-filename-convert').value || `converted.${outputFormat}`;
            
            const progressDiv = document.getElementById('progress-convert');
            const progressFill = document.getElementById('progress-fill-convert');
            const progressText = document.getElementById('progress-text-convert');
            const resultDiv = document.getElementById('result-convert');
            
            // è®¾ç½®å¤„ç†çŠ¶æ€å¹¶ç¦ç”¨æ‰€æœ‰æ§ä»¶
            isConverting = true;
            disableConvertControls();
            
            progressDiv.classList.add('show');
            progressText.textContent = 'æ­£åœ¨è½¬æ¢æ ¼å¼...';
            resultDiv.classList.remove('show');
            
            // åŠ¨æ€è¿›åº¦æ›´æ–°
            let progress = 10;
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
            
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 5;
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }
            }, 500);
            
            try {
                const response = await fetch(`${API_BASE_URL}/plugins/EbookConverter/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'convert',
                        input_file: uploadedFiles.convert,
                        output_format: outputFormat,
                        output_file: outputFilename
                    })
                });
                
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                if (result.success) {
                    resultDiv.className = 'result success show';
                    resultDiv.innerHTML = `
                        <h3>âœ“ è½¬æ¢æˆåŠŸ</h3>
                        <p>æ–‡ä»¶å·²ä¿å­˜</p>
                        <a href="${API_BASE_URL}/download/${result.output_file}" class="download-link">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</a>
                    `;
                } else {
                    resultDiv.className = 'result error show';
                    resultDiv.innerHTML = `
                        <h3>âœ— è½¬æ¢å¤±è´¥</h3>
                        <p>${result.error}</p>
                    `;
                }
            } catch (error) {
                clearInterval(progressInterval);
                resultDiv.className = 'result error show';
                resultDiv.innerHTML = `
                    <h3>âœ— è½¬æ¢å¤±è´¥</h3>
                    <p>${error.message}</p>
                `;
            } finally {
                // æ¢å¤æ‰€æœ‰æ§ä»¶
                isConverting = false;
                enableConvertControls();
            }
        }
        
        // OCRå¤„ç†
        async function processOCR() {
            const outputFormat = document.getElementById('output-format-ocr').value;
            const outputFilename = document.getElementById('output-filename-ocr').value || `ocr.${outputFormat}`;
            
            const progressDiv = document.getElementById('progress-ocr');
            const progressFill = document.getElementById('progress-fill-ocr');
            const progressText = document.getElementById('progress-text-ocr');
            const resultDiv = document.getElementById('result-ocr');
            
            // è®¾ç½®å¤„ç†çŠ¶æ€å¹¶ç¦ç”¨æ‰€æœ‰æ§ä»¶
            isOCRProcessing = true;
            disableOCRControls();
            
            progressDiv.classList.add('show');
            progressText.textContent = 'æ­£åœ¨è¿›è¡ŒOCRè¯†åˆ«...ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰';
            resultDiv.classList.remove('show');
            
            // åŠ¨æ€è¿›åº¦æ›´æ–°ï¼ˆOCRè¾ƒæ…¢ï¼Œè¿›åº¦æ›´æ–°ç¼“æ…¢ï¼‰
            let progress = 5;
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
            
            const progressInterval = setInterval(() => {
                if (progress < 85) {
                    progress += 3;
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }
            }, 1000);
            
            try {
                const response = await fetch(`${API_BASE_URL}/plugins/EbookConverter/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'ocr',
                        input_file: uploadedFiles.ocr,
                        output_format: outputFormat,
                        output_file: outputFilename
                    })
                });
                
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                if (result.success) {
                    resultDiv.className = 'result success show';
                    resultDiv.innerHTML = `
                        <h3>âœ“ OCRè¯†åˆ«æˆåŠŸ</h3>
                        <p>æ–‡ä»¶å·²ä¿å­˜</p>
                        <a href="${API_BASE_URL}/download/${result.output_file}" class="download-link">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</a>
                    `;
                } else {
                    resultDiv.className = 'result error show';
                    resultDiv.innerHTML = `
                        <h3>âœ— OCRè¯†åˆ«å¤±è´¥</h3>
                        <p>${result.error}</p>
                    `;
                }
            } catch (error) {
                clearInterval(progressInterval);
                resultDiv.className = 'result error show';
                resultDiv.innerHTML = `
                    <h3>âœ— OCRè¯†åˆ«å¤±è´¥</h3>
                    <p>${error.message}</p>
                `;
            } finally {
                // æ¢å¤æ‰€æœ‰æ§ä»¶
                isOCRProcessing = false;
                enableOCRControls();
            }
        }
        
        // AIç¿»è¯‘
        async function translateEbook() {
            const provider = document.getElementById('translate-provider').value;
            const model = document.getElementById('translate-model').value;
            const targetLanguage = document.getElementById('target-language').value;
            const outputFormat = document.getElementById('output-format-translate').value;
            const bilingual = document.getElementById('bilingual').checked;
            
            const progressDiv = document.getElementById('progress-translate');
            const progressFill = document.getElementById('progress-fill-translate');
            const progressText = document.getElementById('progress-text-translate');
            const resultDiv = document.getElementById('result-translate');
            
            // è®¾ç½®å¤„ç†çŠ¶æ€å¹¶ç¦ç”¨æ‰€æœ‰æ§ä»¶
            isTranslating = true;
            disableTranslateControls();
            
            progressDiv.classList.add('show');
            progressText.textContent = 'æ­£åœ¨ç¿»è¯‘...ï¼ˆè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰';
            resultDiv.classList.remove('show');
            
            // åˆå§‹è¿›åº¦
            let progress = 5;
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
            
            // è·å–æ–‡ä»¶åç”¨äºè¿›åº¦æŸ¥è¯¢
            const filePath = uploadedFiles.translate || '';
            const fileName = filePath.replace(/\\/g, '/').split('/').pop();
            
            console.log('Translation file name for progress:', fileName);
            
            // å¯åŠ¨è¿›åº¦è½®è¯¢
            const progressInterval = setInterval(async () => {
                if (!isTranslating) {
                    clearInterval(progressInterval);
                    return;
                }
                
                try {
                    const progressResponse = await fetch(`${API_BASE_URL}/plugins/EbookConverter/execute`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'get_progress',
                            file_name: fileName
                        })
                    });
                    
                    const progressData = await progressResponse.json();
                    
                    if (progressData.success && progressData.progress) {
                        const { current, total, status } = progressData.progress;
                        
                        console.log(`Progress update: ${current}/${total}, status: ${status}`);
                        
                        if (total > 0) {
                            // æ ¹æ®å®é™…è¿›åº¦è®¡ç®—ç™¾åˆ†æ¯”ï¼ˆä¿ç•™5%-95%åŒºé—´ï¼‰
                            const realProgress = Math.floor((current / total) * 90) + 5;
                            progressFill.style.width = realProgress + '%';
                            progressFill.textContent = realProgress + '%';
                            progressText.textContent = `æ­£åœ¨ç¿»è¯‘... (${current}/${total} æ®µè½)`;
                        }
                    } else {
                        console.log('Progress response:', progressData);
                    }
                } catch (error) {
                    console.error('è·å–ç¿»è¯‘è¿›åº¦å¤±è´¥:', error);
                }
            }, 2000); // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡
            
            try {
                const response = await fetch(`${API_BASE_URL}/plugins/EbookConverter/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'translate',
                        input_file: uploadedFiles.translate,
                        translate_provider: provider,
                        translate_model: model,
                        target_language: targetLanguage,
                        output_format: outputFormat,
                        bilingual: bilingual
                    })
                });
                
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.textContent = 'ç¿»è¯‘å®Œæˆ';
                
                if (result.success) {
                    resultDiv.className = 'result success show';
                    resultDiv.innerHTML = `
                        <h3>âœ“ ç¿»è¯‘æˆåŠŸ</h3>
                        <p>æ–‡ä»¶å·²ä¿å­˜</p>
                        <a href="${API_BASE_URL}/download/${result.output_file}" class="download-link">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</a>
                    `;
                } else {
                    resultDiv.className = 'result error show';
                    resultDiv.innerHTML = `
                        <h3>âœ— ç¿»è¯‘å¤±è´¥</h3>
                        <p>${result.error}</p>
                    `;
                }
            } catch (error) {
                clearInterval(progressInterval);
                resultDiv.className = 'result error show';
                resultDiv.innerHTML = `
                    <h3>âœ— ç¿»è¯‘å¤±è´¥</h3>
                    <p>${error.message}</p>
                `;
            } finally {
                // æ¢å¤æ‰€æœ‰æ§ä»¶
                isTranslating = false;
                enableTranslateControls();
            }
        }
        
        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        function updateModelList(provider) {
            const modelSelect = document.getElementById('translate-model');
            modelSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            
            if (provider === 'ollama') {
                // ä½¿ç”¨å®é™…å¯ç”¨çš„Ollamaæ¨¡å‹
                if (availableOllamaModels.length > 0) {
                    availableOllamaModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ¨¡å‹ï¼Œæ˜¾ç¤ºé»˜è®¤é€‰é¡¹
                    const defaultModels = ['qwen2.5:7b', 'qwen2.5:14b', 'llama2:13b'];
                    defaultModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                }
            } else if (provider === 'deepseek') {
                // DeepSeekåªæœ‰ä¸€ä¸ªæ¨¡å‹
                const option = document.createElement('option');
                option.value = 'deepseek-chat';
                option.textContent = 'DeepSeek Chat';
                modelSelect.appendChild(option);
            }
        }
        
        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('btn-convert').addEventListener('click', convertFormat);
        document.getElementById('btn-ocr').addEventListener('click', processOCR);
        document.getElementById('btn-translate').addEventListener('click', translateEbook);
        
        // ç»‘å®šç¿»è¯‘æœåŠ¡åˆ‡æ¢äº‹ä»¶
        document.getElementById('translate-provider').addEventListener('change', (e) => {
            updateModelList(e.target.value);
        });
        
        // ç»‘å®šæ ¼å¼åˆ‡æ¢äº‹ä»¶ï¼Œè‡ªåŠ¨æ›´æ–°è¾“å‡ºæ–‡ä»¶æ‰©å±•å
        ['convert', 'ocr', 'translate'].forEach(tabName => {
            const formatSelect = document.getElementById(`output-format-${tabName}`);
            const filenameInput = document.getElementById(`output-filename-${tabName}`);
            
            if (formatSelect && filenameInput) {
                formatSelect.addEventListener('change', () => {
                    const currentFilename = filenameInput.value;
                    if (currentFilename) {
                        // æå–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
                        const lastDotIndex = currentFilename.lastIndexOf('.');
                        const nameWithoutExt = lastDotIndex > 0 ? currentFilename.substring(0, lastDotIndex) : currentFilename;
                        // è®¾ç½®æ–°çš„æ–‡ä»¶åï¼ˆæ–°æ‰©å±•åï¼‰
                        filenameInput.value = `${nameWithoutExt}.${formatSelect.value}`;
                    }
                });
            }
        });
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            checkDependencies();
            setupFileUpload('convert');
            setupFileUpload('ocr');
            setupFileUpload('translate');
            
            // å»¶è¿Ÿä¸€ä¸‹ï¼Œç­‰å¾…ä¾èµ–æ£€æµ‹å®Œæˆåæ›´æ–°æ¨¡å‹åˆ—è¡¨
            setTimeout(() => {
                const provider = document.getElementById('translate-provider').value;
                updateModelList(provider);
            }, 1000);
        });
    </script>
</body>
</html>
